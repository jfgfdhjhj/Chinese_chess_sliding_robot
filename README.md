# 中国象棋机器人，基于写字机器人的python实现

采用皮卡鱼引擎，电动滑轨xyz结构驱动的中国象棋机器人

## 大致流程
1. 棋盘寻找：调用opencv的寻找角点函数，将棋盘角点坐标保存；
2. 局面初始化：用霍夫圆检测检测棋子，将其裁剪，送入模型检测；
3. 棋子识别：采用类似minist的数据集分类模型，将原始棋子进行再处理，送入模型；
4. 棋子移动识别：采用前后图片的红色像素值对比，判断移动情况；
5. 标准棋局摆放：先判断原先的棋子是否占位，占位移走，之后生成路径进行摆放；
6. 残局摆放：输入fen字符串，多余的棋子会拿走，然后和标准棋局摆放同理；
7. 滑轨的驱动：采用grbl操作系统，基于cnc加工的滑轨进行改造，通过串口发送命令；
8. 电磁铁的驱动：考虑到电磁铁的磁滞曲线，有剩磁，用ln298进行驱动，需要3个io口进行控制；


## 运行流程
1. 运行[recognize_board.py](recognize_board.py)首先将识别棋盘函数的is_find_4_corner改为False，拖动滑块，直到找到4个角点为止，按q退出；
2. 之后is_find_4_corner改为True，理论上棋盘棋盘格点会显示出来，按q退出；
3. 之后运行[test_circle.py](test_circle.py)，调解滑块，找到圆稳定为止，按q退出；
4. 运行[camera.py](camera.py)，点击图片，第一次点击为左上角，第二次点击为右下角，按q退出，划出感兴趣的区域；
5. 运行[cheeInterface.py](cheeInterface.py)，里面有残局摆放和正常识别开局，只需要改几个变量就行，理论上可以识别任意局面，注意红色和
  黑色棋子方向，可以参考我拍摄的图片；

# 注意事项
1. 训练权重文件没有上传，因为太大了，而且我的棋子比较小，每个人棋子可能不一样，需要重新训练；
2. 我的权重链接：；
3. 鉴于本人水平有限，程序或多或少有些bug，请大家一起交流，共同改进；
4. 我的棋盘是A3大小，20cm长度，在项目中已经提供，如果棋盘不一样，需要自行修改参数；

## 程序不足
但是鉴于时间有限，还是存在些许不足，
1. 棋子识别的数据集太少，在不同的环境下尤其是棋子反光的情况下，偶尔还是会有识别错误的情况发生；
2. 为了减少计算量，程序设计成了在人行棋之后发送相应的指令程序才会继续运行；
3. 象棋局面摆放的算法依旧显得繁琐，并不是最优解；
4. 滑轨运行速度的合适数值并没有进一步验证， 考虑到步进电机的丢步、精度、散热问题，人为设置成了一个较慢的数值；
5. 机器人的安全性没有考虑，如果人为原因不小心误操作，可能会有安全隐患；
6. 最后一点是程序设计的过于臃肿，总是追求结果的准确，并没有考虑实际的运行速度，尤其是建立在python程序这种解释语言运行的程序基础上，处理速度还是不尽如人意，这为程序的移植埋下了隐患。

# 致谢
感谢各位无私的大佬开源，下面是给我提供参考的链接
1. 皮卡鱼引擎
  https://github.com/official-pikafish/Pikafish
2. 界面设计
  https://github.com/StevenBaby/chess
  https://github.com/windshadow233/python-chinese-chess
3. 胜负判断
  https://github.com/bupticybee/XQPy
4. 模型的训练
  https://github.com/chenyr0021/Chinese_character_recognition/tree/master
5. 思路启蒙
  https://github.com/STM32xxx/Chinese-chess-robot-upper-computer
